<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drowsiness Detection System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .video-container {
            max-width: 800px;
            margin: 0 auto;
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background: #000;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .status-card {
            transition: transform 0.2s;
        }
        .status-card:hover {
            transform: translateY(-2px);
        }
        .detection-log {
            max-height: 300px;
            overflow-y: auto;
            font-size: 0.9rem;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-online {
            background-color: #28a745;
            animation: pulse 2s infinite;
        }
        .status-offline {
            background-color: #dc3545;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
        }
        .alert-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1050;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            display: none;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                üöó Drowsiness Detection System
            </a>
            <div class="navbar-nav ms-auto">
                <span class="nav-link">
                    <span class="status-indicator" id="connection-status"></span>
                    <span id="connection-text">Checking...</span>
                </span>
            </div>
        </div>
    </nav>

    <!-- Alert Banner -->
    <div id="alert-banner" class="alert-banner alert alert-danger">
        <strong>üö® DROWSINESS DETECTED!</strong> Driver needs immediate attention!
    </div>

    <div class="container my-4">
        <div class="row">
            <!-- Video Feed Section -->
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">üìπ Live Video Feed</h5>
                        <span id="monitoring-badge" class="badge bg-secondary">Inactive</span>
                    </div>
                    <div class="card-body text-center">
                        <div class="video-container">
                            <img id="video-stream" src="/video_feed" alt="Video Feed" class="img-fluid" 
                                 style="max-width: 100%; height: auto; display: none;">
                            <div id="video-placeholder" class="text-white">
                                <i style="font-size: 4rem;">üì∑</i>
                                <p class="mt-2">Click "Start Monitoring" to begin</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Control Panel -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="mb-0">üéõÔ∏è Control Panel</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-2">
                            <div class="col-md-6">
                                <button id="start-btn" class="btn btn-success w-100" onclick="startMonitoring()">
                                    ‚ñ∂Ô∏è Start Monitoring
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button id="stop-btn" class="btn btn-danger w-100" onclick="stopMonitoring()" disabled>
                                    ‚èπÔ∏è Stop Monitoring
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-warning w-100" onclick="testESP32()">
                                    üîß Test ESP32
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-info w-100" onclick="manualAlert()">
                                    üö® Manual Alert
                                </button>
                            </div>
                            <div class="col-md-4">
                                <a href="/dashboard" class="btn btn-primary w-100">
                                    üìä Dashboard
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status and Info Section -->
            <div class="col-lg-4">
                <!-- System Status -->
                <div class="card status-card">
                    <div class="card-header">
                        <h5 class="mb-0">‚ÑπÔ∏è System Status</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-2 text-center">
                            <div class="col-6">
                                <div class="p-2 border rounded">
                                    <small class="text-muted">Monitoring</small><br>
                                    <span id="monitoring-status" class="badge bg-secondary">Inactive</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-2 border rounded">
                                    <small class="text-muted">ESP32</small><br>
                                    <span id="esp32-status" class="badge bg-secondary">Unknown</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-2 border rounded">
                                    <small class="text-muted">Model</small><br>
                                    <span id="model-status" class="badge bg-secondary">Unknown</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-2 border rounded">
                                    <small class="text-muted">ESP32 IP</small><br>
                                    <code>{{ esp32_ip }}</code>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Latest Detection -->
                <div class="card status-card mt-3">
                    <div class="card-header">
                        <h5 class="mb-0">üëÅÔ∏è Latest Detection</h5>
                    </div>
                    <div class="card-body">
                        <div id="latest-detection" class="alert alert-secondary">
                            <div class="text-center">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                                <span class="ms-2">Waiting for detection data...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Detections -->
                <div class="card status-card mt-3">
                    <div class="card-header">
                        <h5 class="mb-0">üìà Recent Detections</h5>
                    </div>
                    <div class="card-body">
                        <div id="recent-detections" class="detection-log">
                            <p class="text-muted text-center">No recent detections</p>
                        </div>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="card status-card mt-3">
                    <div class="card-header">
                        <h5 class="mb-0">üìä Quick Stats</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6">
                                <h4 id="total-detections" class="text-primary">0</h4>
                                <small class="text-muted">Total Detections</small>
                            </div>
                            <div class="col-6">
                                <h4 id="drowsy-detections" class="text-danger">0</h4>
                                <small class="text-muted">Drowsy Events</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="notification-toast" class="toast" role="alert">
            <div class="toast-header">
                <strong class="me-auto">System Notification</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toast-message">
                <!-- Toast message will be inserted here -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let isMonitoring = {{ is_monitoring|lower }};
        let lastDrowsyAlert = 0;

        // Show notification
        function showNotification(message, type = 'info') {
            const toast = document.getElementById('notification-toast');
            const toastBody = document.getElementById('toast-message');
            
            // Set message and styling
            toastBody.textContent = message;
            toast.className = `toast show bg-${type === 'error' ? 'danger' : type}`;
            
            // Show toast
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // Update system status
        function updateSystemStatus() {
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    // Update monitoring status
                    const monitoringBadge = document.getElementById('monitoring-badge');
                    const monitoringStatus = document.getElementById('monitoring-status');
                    const status = data.monitoring ? 'Active' : 'Inactive';
                    const className = data.monitoring ? 'badge bg-success' : 'badge bg-secondary';
                    
                    if (monitoringBadge) {
                        monitoringBadge.className = className;
                        monitoringBadge.textContent = status;
                    }
                    if (monitoringStatus) {
                        monitoringStatus.className = className;
                        monitoringStatus.textContent = status;
                    }

                    // Update ESP32 connection status
                    const esp32Status = document.getElementById('esp32-status');
                    const connectionStatus = document.getElementById('connection-status');
                    const connectionText = document.getElementById('connection-text');
                    
                    if (esp32Status) {
                        esp32Status.className = data.esp32_connected ? 'badge bg-success' : 'badge bg-danger';
                        esp32Status.textContent = data.esp32_connected ? 'Connected' : 'Disconnected';
                    }
                    if (connectionStatus && connectionText) {
                        connectionStatus.className = data.esp32_connected ? 'status-indicator status-online' : 'status-indicator status-offline';
                        connectionText.textContent = data.esp32_connected ? 'ESP32 Online' : 'ESP32 Offline';
                    }

                    // Update model status
                    const modelStatus = document.getElementById('model-status');
                    if (modelStatus) {
                        modelStatus.className = data.model_loaded ? 'badge bg-success' : 'badge bg-warning';
                        modelStatus.textContent = data.model_loaded ? 'Loaded' : 'Mock Mode';
                    }

                    // Update latest detection
                    const latestDetection = document.getElementById('latest-detection');
                    if (latestDetection && data.latest_detection) {
                        const detection = data.latest_detection;
                        const time = new Date(detection.timestamp).toLocaleTimeString();
                        const status = detection.drowsy ? 'DROWSY' : 'ALERT';
                        const confidence = (detection.confidence * 100).toFixed(1);
                        
                        latestDetection.innerHTML = `
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong class="${detection.drowsy ? 'text-danger' : 'text-success'}">${status}</strong>
                                    <br><small>at ${time}</small>
                                </div>
                                <div class="text-end">
                                    <div class="badge ${detection.drowsy ? 'bg-danger' : 'bg-success'}">
                                        ${confidence}%
                                    </div>
                                </div>
                            </div>
                        `;
                        latestDetection.className = detection.drowsy ? 'alert alert-danger' : 'alert alert-success';
                        
                        // Show alert banner if drowsy
                        if (detection.drowsy && (Date.now() - lastDrowsyAlert > 10000)) { // Show every 10 seconds max
                            showDrowsinessAlert();
                            lastDrowsyAlert = Date.now();
                        }
                    }

                    // Update total detections
                    const totalElement = document.getElementById('total-detections');
                    if (totalElement) {
                        totalElement.textContent = data.total_detections || 0;
                    }

                    // Update button states
                    updateButtonStates(data.monitoring);
                })
                .catch(error => {
                    console.error('Error updating status:', error);
                    showNotification('Failed to update system status', 'error');
                });
        }

        // Update recent detections
        function updateRecentDetections() {
            fetch('/detections')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('recent-detections');
                    if (container && data.detections && data.detections.length > 0) {
                        container.innerHTML = '';
                        let drowsyCount = 0;
                        
                        data.detections.slice(-5).reverse().forEach(detection => {
                            const time = new Date(detection.timestamp).toLocaleTimeString();
                            const status = detection.drowsy ? 'DROWSY' : 'ALERT';
                            const confidence = (detection.confidence * 100).toFixed(1);
                            const badgeClass = detection.drowsy ? 'bg-danger' : 'bg-success';
                            
                            if (detection.drowsy) drowsyCount++;
                            
                            const item = document.createElement('div');
                            item.className = 'border-bottom py-2 mb-2';
                            item.innerHTML = `
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <span class="badge ${badgeClass}">${status}</span>
                                        <small class="text-muted ms-2">${time}</small>
                                    </div>
                                    <small class="text-muted">${confidence}%</small>
                                </div>
                            `;
                            container.appendChild(item);
                        });

                        // Update drowsy count
                        const drowsyElement = document.getElementById('drowsy-detections');
                        if (drowsyElement) {
                            drowsyElement.textContent = drowsyCount;
                        }
                    } else if (container) {
                        container.innerHTML = '<p class="text-muted text-center">No recent detections</p>';
                    }
                })
                .catch(error => console.error('Error updating detections:', error));
        }

        // Show drowsiness alert banner
        function showDrowsinessAlert() {
            const banner = document.getElementById('alert-banner');
            banner.style.display = 'block';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                banner.style.display = 'none';
            }, 5000);
        }

        // Update button states
        function updateButtonStates(monitoring) {
            const startBtn = document.getElementById('start-btn');
            const stopBtn = document.getElementById('stop-btn');
            const videoStream = document.getElementById('video-stream');
            const videoPlaceholder = document.getElementById('video-placeholder');
            
            if (startBtn) startBtn.disabled = monitoring;
            if (stopBtn) stopBtn.disabled = !monitoring;
            
            if (monitoring) {
                if (videoStream) videoStream.style.display = 'block';
                if (videoPlaceholder) videoPlaceholder.style.display = 'none';
            } else {
                if (videoStream) videoStream.style.display = 'none';
                if (videoPlaceholder) videoPlaceholder.style.display = 'flex';
            }
        }

        // Start monitoring
        function startMonitoring() {
            showNotification('Starting monitoring system...', 'info');
            
            fetch('/start_monitoring', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    isMonitoring = true;
                    showNotification('Monitoring started successfully!', 'success');
                    updateButtonStates(true);
                } else {
                    showNotification(data.message || 'Failed to start monitoring', 'warning');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Failed to start monitoring', 'error');
            });
        }

        // Stop monitoring
        function stopMonitoring() {
            showNotification('Stopping monitoring system...', 'info');
            
            fetch('/stop_monitoring', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    isMonitoring = false;
                    showNotification('Monitoring stopped successfully!', 'success');
                    updateButtonStates(false);
                    
                    // Hide alert banner
                    document.getElementById('alert-banner').style.display = 'none';
                } else {
                    showNotification(data.message || 'Failed to stop monitoring', 'warning');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Failed to stop monitoring', 'error');
            });
        }

        // Test ESP32
        function testESP32() {
            showNotification('Testing ESP32-CAM connection...', 'info');
            
            fetch('/test_esp32')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showNotification('ESP32-CAM test completed successfully!', 'success');
                } else {
                    showNotification(data.message || 'ESP32-CAM test failed', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Failed to test ESP32-CAM', 'error');
            });
        }

        // Manual alert
        function manualAlert() {
            showNotification('Triggering manual alert...', 'info');
            
            fetch('/manual_alert')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showNotification('Manual alert triggered successfully!', 'warning');
                    showDrowsinessAlert();
                    
                    // Auto-stop alert after 3 seconds
                    setTimeout(() => {
                        fetch('/stop_alert_esp32');
                    }, 3000);
                } else {
                    showNotification(data.message || 'Failed to trigger alert', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Failed to trigger manual alert', 'error');
            });
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöó Drowsiness Detection System initialized');
            
            // Initial status update
            updateSystemStatus();
            updateRecentDetections();
            
            // Set up periodic updates
            setInterval(updateSystemStatus, 2000);      // Update status every 2 seconds
            setInterval(updateRecentDetections, 5000);   // Update detections every 5 seconds
            
            // Initialize button states
            updateButtonStates(isMonitoring);
        });
    </script>
</body>
</html>